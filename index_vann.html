<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vannkraftsystemer Visualizer - NVE</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%23f0f0f0' width='32' height='32'/%3E%3Cpath fill='%230066cc' d='M16 2L8 16h16L16 2zM8 18l8 12 8-12H8z'/%3E%3C/svg%3E">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0066cc 0%, #0099ff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 500px 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            max-height: calc(100vh - 40px);
        }

        .left-top-section {
            grid-column: 1;
            grid-row: 1;
            min-height: 350px;
        }

        .graph-section {
            grid-column: 2;
            grid-row: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 450px;
            max-height: 600px;
        }

        .results-section {
            grid-column: 1;
            grid-row: 2;
        }

        .detail-section {
            grid-column: 2;
            grid-row: 2;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.6rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header .stats {
            font-size: 0.8rem;
            opacity: 0.95;
            text-align: right;
            line-height: 1.5;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 102, 204, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-progress {
            font-size: 1rem;
            opacity: 0.9;
        }

        .search-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .search-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 10px;
            align-items: center;
        }

        .input-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.85rem;
            text-align: right;
        }

        .input-group input, .input-group select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #0066cc;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .reset-btn {
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .reset-btn:hover {
            background: #ee5a52;
        }

        .results-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-height: 100%;
            overflow-y: auto;
        }

        .result-item {
            padding: 12px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-item:hover {
            border-color: #0066cc;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.2);
        }

        .result-item.selected {
            border-color: #0066cc;
            background: #e6f2ff;
        }

        .result-item h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white !important;
            background: #666; /* Default background for unknown types */
        }

        .type-badge.vannkraftverk { background: #0066cc !important; }
        .type-badge.dam { background: #8B4513 !important; }
        .type-badge.magasin { background: #1E90FF !important; }
        .type-badge.vannvei { background: #4682B4 !important; }
        .type-badge.inntakspunkt { background: #228B22 !important; }
        .type-badge.utlopspunkt { background: #FF6347 !important; }

        .result-item .meta {
            color: #666;
            font-size: 0.85rem;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .detail-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .detail-panel.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }

        .detail-header {
            border-bottom: 3px solid #0066cc;
            padding-bottom: 12px;
            margin-bottom: 15px;
        }

        .detail-header h2 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-header .subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0066cc;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f8f9ff;
            border-radius: 6px;
        }

        .detail-item .label {
            font-weight: 600;
            color: #0066cc;
            font-size: 0.75rem;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .detail-item .value {
            color: #333;
            font-size: 0.95rem;
            word-break: break-word;
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .related-items {
            margin-top: 15px;
        }

        .related-item {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .related-item:hover {
            border-color: #0066cc;
            background: #f8f9ff;
        }

        .related-item h4 {
            color: #333;
            font-size: 0.95rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .related-item .meta {
            color: #666;
            font-size: 0.8rem;
        }

        .maps-btn {
            padding: 8px 14px;
            background: linear-gradient(135deg, #0066cc 0%, #0099ff 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .maps-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
        }

        .konsesjon-btn {
            padding: 8px 14px;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .konsesjon-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
        }

        .utbygd-btn {
            padding: 8px 14px;
            background: linear-gradient(135deg, #c62828 0%, #e53935 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .utbygd-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.4);
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        #graphContainer {
            width: 100%;
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            min-height: 300px;
        }

        .graph-section h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }

            .left-top-section {
                grid-column: 1;
                grid-row: 1;
            }

            .graph-section {
                grid-column: 1;
                grid-row: 2;
            }

            .results-section {
                grid-column: 1;
                grid-row: 3;
            }

            .detail-section {
                grid-column: 1;
                grid-row: 4;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Laster vannkraftsystemer fra NVE</div>
        <div class="loading-progress" id="loadingProgress">Starter...</div>
    </div>

    <div class="container">
        <!-- Top left: Header + Search -->
        <div class="left-top-section">
            <div class="header">
                <h1>Vannkraftsystemer i Norge</h1>
                <div class="stats" id="stats">Laster data...</div>
            </div>

            <div class="search-panel">
                <div class="search-grid">
                    <div class="input-group">
                        <label for="searchName">S√∏k etter navn</label>
                        <input type="text" id="searchName" placeholder="Kraftverk, dam, magasin...">
                    </div>
                    <div class="input-group">
                        <label for="searchType">Type anlegg</label>
                        <select id="searchType">
                            <option value="">Alle typer</option>
                            <option value="vannkraftverk">Vannkraftverk</option>
                            <option value="dam">Dam</option>
                            <option value="magasin">Magasin</option>
                            <option value="vannvei">Vannvei</option>
                            <option value="inntakspunkt">Inntakspunkt</option>
                            <option value="utlopspunkt">Utl√∏pspunkt</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="searchKommune">Kommune</label>
                        <select id="searchKommune">
                            <option value="">Alle kommuner</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="searchVassdrags">Vassdragsnummer</label>
                        <input type="text" id="searchVassdrags" placeholder="F.eks. 027.6B">
                    </div>
                </div>
                <div class="filter-row">
                    <button class="reset-btn" onclick="resetFilters()">Nullstill alle filtre</button>
                </div>
            </div>
        </div>

        <!-- Top right: Graph -->
        <div class="graph-section">
            <h2>
                Relasjonsgraf
                <button onclick="resetGraph()" style="padding: 5px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Nullstill graf</button>
            </h2>
            <div id="graphContainer"></div>
        </div>

        <!-- Bottom left: Results -->
        <div class="results-section">
            <div class="results-panel" id="resultsPanel">
                <div class="empty-state">S√∏k etter et anlegg for √• se detaljer</div>
            </div>
        </div>

        <!-- Bottom right: Details -->
        <div class="detail-section">
            <div class="detail-panel empty" id="detailPanel">
                <div class="empty-state">Velg et anlegg fra listen for √• se detaljert informasjon og relaterte objekter</div>
            </div>
        </div>
    </div>

    <script>
        let allData = {
            vannkraftverk: [],
            dammer: [],
            magasiner: [],
            vannveier: [],
            inntakspunkt: [],
            utlopspunkt: []
        };

        let currentSelection = null;
        let filteredResults = [];
        let currentRelatedItems = [];

        // Graph visualization state
        let graphNetwork = null;
        let graphNodes = new vis.DataSet([]);
        let graphEdges = new vis.DataSet([]);
        let currentGraphKraftverk = null; // Track which kraftverk is currently shown in graph

        // Load data from JSONL files
        async function loadData() {
            const loadingProgress = document.getElementById('loadingProgress');

            try {
                loadingProgress.textContent = 'Laster vannkraftverk...';
                allData.vannkraftverk = await loadJSONL('../NVE_DATA/vannkraftverk.jsonl');

                loadingProgress.textContent = 'Laster dammer...';
                allData.dammer = await loadJSONL('../NVE_DATA/dammer.jsonl');

                loadingProgress.textContent = 'Laster magasiner...';
                allData.magasiner = await loadJSONL('../NVE_DATA/magasiner.jsonl');

                loadingProgress.textContent = 'Laster vannveier...';
                allData.vannveier = await loadJSONL('../NVE_DATA/vannveier.jsonl');

                loadingProgress.textContent = 'Laster inntakspunkt...';
                allData.inntakspunkt = await loadJSONL('../NVE_DATA/inntakspunkt.jsonl');

                loadingProgress.textContent = 'Laster utl√∏pspunkt...';
                allData.utlopspunkt = await loadJSONL('../NVE_DATA/utlopspunkt.jsonl');

                loadingProgress.textContent = 'Beriking data...';

                // Enrich utl√∏pspunkt with vannkraftverkNavn (missing from NVE API)
                allData.utlopspunkt.forEach(utlop => {
                    if (utlop.vannkraftverkNr && !utlop.vannkraftverkNavn) {
                        const kraftverk = allData.vannkraftverk.find(k => k.vannkraftverkNr === utlop.vannkraftverkNr);
                        if (kraftverk) {
                            utlop.vannkraftverkNavn = kraftverk.vannkraftverkNavn;
                        }
                    }
                });

                loadingProgress.textContent = 'Ferdig!';

                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);

                // Update stats
                updateStats();

                // Populate filters
                populateFilters();

                // Initial filter
                filterData();

            } catch (error) {
                console.error('Error loading data:', error);
                loadingProgress.textContent = 'Feil ved lasting av data: ' + error.message;
            }
        }

        async function loadJSONL(path) {
            const response = await fetch(path);
            if (!response.ok) {
                throw new Error(`Failed to load ${path}: ${response.statusText}`);
            }
            const text = await response.text();
            const lines = text.trim().split('\n');
            return lines.map(line => JSON.parse(line));
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                ${allData.vannkraftverk.length.toLocaleString()} vannkraftverk<br>
                ${allData.dammer.length.toLocaleString()} dammer<br>
                ${allData.magasiner.length.toLocaleString()} magasiner<br>
                ${allData.vannveier.length.toLocaleString()} vannveier<br>
                ${allData.inntakspunkt.length.toLocaleString()} inntakspunkt<br>
                ${allData.utlopspunkt.length.toLocaleString()} utl√∏pspunkt
            `;
        }

        function populateFilters() {
            // Get all kommuner
            const kommuner = new Set();

            allData.vannkraftverk.forEach(v => v.kommuneNavn && kommuner.add(v.kommuneNavn));
            allData.dammer.forEach(d => d.kommuneNavn && kommuner.add(d.kommuneNavn));
            allData.magasiner.forEach(m => m.kommuneNavn && kommuner.add(m.kommuneNavn));

            const kommuneSelect = document.getElementById('searchKommune');
            [...kommuner].sort().forEach(kommune => {
                const option = document.createElement('option');
                option.value = kommune;
                option.textContent = kommune;
                kommuneSelect.appendChild(option);
            });
        }

        function filterData() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchType = document.getElementById('searchType').value;
            const searchKommune = document.getElementById('searchKommune').value;
            const searchVassdrags = document.getElementById('searchVassdrags').value.toLowerCase();

            filteredResults = [];

            // Helper function to match filters
            function matches(item, type) {
                if (searchName) {
                    // Build a search string with all relevant names
                    const searchableText = [
                        item.vannkraftverkNavn,
                        item.damNavn,
                        item.magasinNavn
                    ].filter(Boolean).join(' ').toLowerCase();

                    if (!searchableText.includes(searchName)) return false;
                }

                if (searchType && searchType !== type) return false;

                // Only apply kommune filter if the item has kommuneNavn field
                if (searchKommune && item.kommuneNavn && item.kommuneNavn !== searchKommune) return false;

                if (searchVassdrags && (!item.vassdragsNr || !item.vassdragsNr.toLowerCase().includes(searchVassdrags))) return false;

                return true;
            }

            // Filter each type
            if (!searchType || searchType === 'vannkraftverk') {
                allData.vannkraftverk.forEach(item => {
                    if (matches(item, 'vannkraftverk')) {
                        filteredResults.push({ ...item, _type: 'vannkraftverk' });
                    }
                });
            }

            if (!searchType || searchType === 'dam') {
                allData.dammer.forEach(item => {
                    if (matches(item, 'dam')) {
                        filteredResults.push({ ...item, _type: 'dam' });
                    }
                });
            }

            if (!searchType || searchType === 'magasin') {
                allData.magasiner.forEach(item => {
                    if (matches(item, 'magasin')) {
                        filteredResults.push({ ...item, _type: 'magasin' });
                    }
                });
            }

            if (!searchType || searchType === 'vannvei') {
                allData.vannveier.forEach(item => {
                    if (matches(item, 'vannvei')) {
                        filteredResults.push({ ...item, _type: 'vannvei' });
                    }
                });
            }

            if (!searchType || searchType === 'inntakspunkt') {
                allData.inntakspunkt.forEach(item => {
                    if (matches(item, 'inntakspunkt')) {
                        filteredResults.push({ ...item, _type: 'inntakspunkt' });
                    }
                });
            }

            if (!searchType || searchType === 'utlopspunkt') {
                allData.utlopspunkt.forEach(item => {
                    if (matches(item, 'utlopspunkt')) {
                        filteredResults.push({ ...item, _type: 'utlopspunkt' });
                    }
                });
            }

            displayResults();
        }

        function getItemName(item) {
            // For items with specific name fields
            if (item.damNavn) return item.damNavn;
            if (item.magasinNavn) return item.magasinNavn;
            if (item.vannkraftverkNavn && item._type === 'vannkraftverk') return item.vannkraftverkNavn;

            // For vannveier - show type and details
            if (item._type === 'vannvei') {
                const type = item.objektType || 'Vannvei';
                const id = item.vannveiID || item.OBJECTID;
                const lengde = item.vannveiLengde_m ? ` (${Math.round(item.vannveiLengde_m)}m)` : '';
                return `${type} ${id}${lengde}`;
            }

            // For inntaks/utl√∏pspunkt - show ID
            if (item._type === 'inntakspunkt') {
                const id = item.inntakspunktID || item.OBJECTID;
                return `Inntakspunkt ${id}`;
            }
            if (item._type === 'utlopspunkt') {
                const id = item.utlopspunktID || item.OBJECTID;
                return `Utl√∏pspunkt ${id}`;
            }

            // Fallback
            return `${item._type} ${item.OBJECTID}`;
        }

        function displayResults() {
            const resultsPanel = document.getElementById('resultsPanel');

            if (filteredResults.length === 0) {
                resultsPanel.innerHTML = '<div class="empty-state">Ingen resultater funnet</div>';
                return;
            }

            resultsPanel.innerHTML = filteredResults.slice(0, 200).map((item, index) => {
                const name = getItemName(item);
                const kommune = item.kommuneNavn || item.kommunenummer || '';
                const kdbNr = item.kdbNr || '';
                const vassdrags = item.vassdragsNr || '';

                return `
                    <div class="result-item" onclick="selectItem(${index})">
                        <h3>
                            <span class="type-badge ${item._type}">${getTypeName(item._type)}</span>
                            ${name}
                        </h3>
                        <div class="meta">
                            ${kommune ? `<span>üìç ${kommune}</span>` : ''}
                            ${kdbNr ? `<span>üîë KDB: ${kdbNr}</span>` : ''}
                            ${vassdrags ? `<span>üíß ${vassdrags}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            if (filteredResults.length > 200) {
                resultsPanel.innerHTML += `<div style="padding: 15px; text-align: center; color: #666;">Viser f√∏rste 200 av ${filteredResults.length} resultater. Bruk filtre for √• begrense s√∏ket.</div>`;
            }
        }

        function getTypeName(type) {
            const names = {
                vannkraftverk: 'Kraftverk',
                dam: 'Dam',
                magasin: 'Magasin',
                vannvei: 'Vannvei',
                inntakspunkt: 'Inntak',
                utlopspunkt: 'Utl√∏p'
            };
            return names[type] || type;
        }

        function selectItem(index, focusInGraph = true) {
            currentSelection = filteredResults[index];

            // Update selected styling
            document.querySelectorAll('.result-item').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });

            displayDetail(currentSelection, focusInGraph);
        }

        function displayDetail(item, focusInGraph = true) {
            const detailPanel = document.getElementById('detailPanel');
            detailPanel.classList.remove('empty');

            const name = getItemName(item);

            // Build action buttons HTML
            let actionButtons = '';

            // Map button
            if (item.lat && item.lon) {
                actionButtons += `<button class="maps-btn" onclick="openMap(${item.lat}, ${item.lon}, '${name.replace(/'/g, "\\'")}')">üó∫Ô∏è Maps</button>`;
            } else if (item.center_lat && item.center_lon) {
                actionButtons += `<button class="maps-btn" onclick="openMap(${item.center_lat}, ${item.center_lon}, '${name.replace(/'/g, "\\'")}')">üó∫Ô∏è Maps</button>`;
            }

            // KDB/Konsesjon button
            if (item.kdbNr) {
                actionButtons += `<button class="konsesjon-btn" onclick="openInKonsesjon(${item.kdbNr})">üìã KDB</button>`;
            }

            // Utbygd button (only for vannkraftverk)
            if (item._type === 'vannkraftverk' && item.vannkraftverkNr) {
                actionButtons += `<button class="utbygd-btn" onclick="openInUtbygd(${item.vannkraftverkNr})">üè≠ Utbygd</button>`;
            }

            let html = `
                <div class="detail-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                        <div style="flex: 1; min-width: 0;">
                            <h2>
                                <span class="type-badge ${item._type}">${getTypeName(item._type)}</span>
                                ${name}
                            </h2>
                            <div class="subtitle">OBJECTID: ${item.OBJECTID}</div>
                        </div>
                        ${actionButtons ? `<div style="display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0;">${actionButtons}</div>` : ''}
                    </div>
                </div>
            `;

            // Main properties
            html += '<div class="section"><div class="section-title">Egenskaper</div><div class="detail-grid">';

            const props = getItemProperties(item);
            props.forEach(prop => {
                html += `
                    <div class="detail-item ${prop.fullWidth ? 'full-width' : ''}">
                        <div class="label">${prop.label}</div>
                        <div class="value">${prop.value !== null && prop.value !== undefined ? prop.value : '-'}</div>
                    </div>
                `;
            });

            html += '</div></div>';

            // Related items
            const related = findRelatedItems(item);
            currentRelatedItems = related; // Store globally
            if (related.length > 0) {
                html += '<div class="section"><div class="section-title">Relaterte objekter (' + related.length + ')</div><div class="related-items">';
                related.forEach((rel, relIndex) => {
                    const relName = getItemName(rel);
                    // Show kraftverk info for related items if available and not already shown in relation reason
                    let metaInfo = rel.relationReason;
                    if (rel._type !== 'vannkraftverk' && rel.vannkraftverkNavn && !rel.relationReason.includes(rel.vannkraftverkNavn)) {
                        metaInfo = `‚ö° ${rel.vannkraftverkNavn} ‚Ä¢ ${rel.relationReason}`;
                    }

                    html += `
                        <div class="related-item" data-rel-index="${relIndex}">
                            <h4>
                                <span class="type-badge ${rel._type}">${getTypeName(rel._type)}</span>
                                ${relName}
                            </h4>
                            <div class="meta">${metaInfo}</div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            detailPanel.innerHTML = html;

            // Update graph in its own panel - use direct relations for cleaner graph
            const directRelations = findDirectRelations(item);
            updateGraph(item, directRelations, focusInGraph);
        }

        function updateGraph(centerItem, relatedItems, focusNode = true) {
            const container = document.getElementById('graphContainer');
            if (!container) return;

            // Get node ID
            const getNodeId = (item) => `${item._type}-${item.OBJECTID}`;

            // Check if this node is already in the current graph
            const clickedNodeId = getNodeId(centerItem);
            const nodeExistsInGraph = graphNodes.get(clickedNodeId) !== null;

            // Determine which kraftverk this item belongs to and decide if we should clear
            let itemKraftverkId = null;
            let shouldClearGraph = false;

            if (centerItem._type === 'vannkraftverk') {
                itemKraftverkId = centerItem.vannkraftverkNr || centerItem.vannkraftverkNavn || centerItem.OBJECTID;

                // For kraftverk: clear graph unless this kraftverk is already at level 0
                if (nodeExistsInGraph) {
                    const existingNode = graphNodes.get(clickedNodeId);
                    if (existingNode && existingNode.level === 0) {
                        // Already the main kraftverk at level 0, just highlight it
                        if (graphNetwork) {
                            graphNetwork.selectNodes([clickedNodeId]);

                            if (focusNode) {
                                const scrollX = window.scrollX;
                                const scrollY = window.scrollY;

                                graphNetwork.focus(clickedNodeId, {
                                    scale: 1.0,
                                    animation: {
                                        duration: 500,
                                        easingFunction: 'easeInOutQuad'
                                    }
                                });

                                setTimeout(() => {
                                    window.scrollTo(scrollX, scrollY);
                                }, 0);
                            } else {
                                const nodePosition = graphNetwork.getPositions([clickedNodeId])[clickedNodeId];
                                const viewPosition = graphNetwork.getViewPosition();

                                if (nodePosition) {
                                    graphNetwork.moveTo({
                                        position: { x: nodePosition.x, y: viewPosition.y },
                                        scale: graphNetwork.getScale(),
                                        animation: {
                                            duration: 500,
                                            easingFunction: 'easeInOutQuad'
                                        }
                                    });
                                }
                            }
                        }
                        return;
                    } else {
                        // Kraftverk exists but not at level 0, need to rebuild
                        shouldClearGraph = true;
                    }
                } else {
                    // Kraftverk doesn't exist in graph, need to build it
                    shouldClearGraph = true;
                }

                if (shouldClearGraph) {
                    graphNodes.clear();
                    graphEdges.clear();
                    currentGraphKraftverk = itemKraftverkId;
                }
            } else if (centerItem.vannkraftverkNr || centerItem.vannkraftverkNavn) {
                itemKraftverkId = centerItem.vannkraftverkNr || centerItem.vannkraftverkNavn;

                // For non-kraftverk: check if we should just highlight or rebuild
                if (nodeExistsInGraph && graphNetwork) {
                    // Just highlight the existing node
                    graphNetwork.selectNodes([clickedNodeId]);

                    if (focusNode) {
                        const scrollX = window.scrollX;
                        const scrollY = window.scrollY;

                        graphNetwork.focus(clickedNodeId, {
                            scale: 1.0,
                            animation: {
                                duration: 500,
                                easingFunction: 'easeInOutQuad'
                            }
                        });

                        setTimeout(() => {
                            window.scrollTo(scrollX, scrollY);
                        }, 0);
                    } else {
                        const nodePosition = graphNetwork.getPositions([clickedNodeId])[clickedNodeId];
                        const viewPosition = graphNetwork.getViewPosition();

                        if (nodePosition) {
                            graphNetwork.moveTo({
                                position: { x: nodePosition.x, y: viewPosition.y },
                                scale: graphNetwork.getScale(),
                                animation: {
                                    duration: 500,
                                    easingFunction: 'easeInOutQuad'
                                }
                            });
                        }
                    }
                    return;
                }

                // Clear graph if switching to a different kraftverk
                if (itemKraftverkId !== currentGraphKraftverk) {
                    graphNodes.clear();
                    graphEdges.clear();
                    currentGraphKraftverk = itemKraftverkId;
                }
            } else {
                // If this is not a kraftverk and has no kraftverk relation, clear graph
                graphNodes.clear();
                graphEdges.clear();
                currentGraphKraftverk = null;
            }

            // Get node color based on type
            const getNodeColor = (type) => {
                const colors = {
                    'vannkraftverk': '#0066cc',
                    'dam': '#8B4513',
                    'magasin': '#1E90FF',
                    'vannvei': '#4682B4',
                    'inntakspunkt': '#228B22',
                    'utlopspunkt': '#FF6347'
                };
                return colors[type] || '#666';
            };

            // Get type name for display
            const getTypeName = (type) => {
                const names = {
                    'vannkraftverk': 'Kraftverk',
                    'dam': 'Dam',
                    'magasin': 'Magasin',
                    'vannvei': 'Vannvei',
                    'inntakspunkt': 'Inntak',
                    'utlopspunkt': 'Utl√∏p'
                };
                return names[type] || type;
            };

            // Get short label with type name
            const getLabel = (item) => {
                const name = getItemName(item);
                const typeName = getTypeName(item._type);
                // Truncate long names to make room for type name
                const maxNameLength = 20;
                const truncatedName = name.length > maxNameLength ? name.substring(0, maxNameLength - 3) + '...' : name;
                return `${truncatedName}\n(${typeName})`;
            };

            // Get sort order for type (to group by type on same level)
            const getTypeSortOrder = (type) => {
                const order = {
                    'dam': 1,
                    'magasin': 2,
                    'vannvei': 3,
                    'inntakspunkt': 4,
                    'utlopspunkt': 5
                };
                return order[type] || 99;
            };

            // Add center node
            const centerId = getNodeId(centerItem);
            // Kraftverk should always be at level 0 (top), everything else at level 1 (bottom)
            const centerIsKraftverk = centerItem._type === 'vannkraftverk';
            const centerLevel = centerIsKraftverk ? 0 : 1;

            graphNodes.add({
                id: centerId,
                label: getLabel(centerItem),
                color: getNodeColor(centerItem._type),
                font: { color: 'white', size: 14, bold: true },
                shape: 'box',
                level: centerLevel,
                item: centerItem
            });

            // Sort related items by type for better visual grouping
            const sortedRelated = [...relatedItems].sort((a, b) => {
                return getTypeSortOrder(a._type) - getTypeSortOrder(b._type);
            });

            // Add related nodes and edges
            sortedRelated.forEach(rel => {
                const relId = getNodeId(rel);

                // Determine level: magasiner with parent dams go to level 2, others to level 1
                const nodeLevel = (rel._type === 'magasin' && rel._parentDamIds && rel._parentDamIds.length > 0) ? 2 : 1;

                graphNodes.add({
                    id: relId,
                    label: getLabel(rel),
                    color: getNodeColor(rel._type),
                    font: { color: 'white', size: 12 },
                    shape: 'box',
                    level: nodeLevel,
                    item: rel
                });

                // Add edges from parent(s)
                if (rel._parentDamIds && rel._parentDamIds.length > 0) {
                    // Magasin with parent dam(s): edge from each dam to magasin
                    rel._parentDamIds.forEach(parentDamObjectId => {
                        const parentDamId = `dam-${parentDamObjectId}`;
                        graphEdges.add({
                            id: `${parentDamId}-${relId}`,
                            from: parentDamId,
                            to: relId,
                            arrows: 'to',
                            color: { color: '#999', highlight: '#666' },
                            width: 2
                        });
                    });
                } else {
                    // Direct child of kraftverk: edge from kraftverk to child
                    graphEdges.add({
                        id: `${centerId}-${relId}`,
                        from: centerId,
                        to: relId,
                        arrows: 'to',
                        color: { color: '#999', highlight: '#666' },
                        width: 2
                    });
                }
            });

            // Destroy and recreate network to apply changes
            if (graphNetwork) {
                graphNetwork.destroy();
                graphNetwork = null;
            }

            // Create network
            const data = {
                nodes: graphNodes,
                edges: graphEdges
            };

            const options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',           // Up-Down (top to bottom)
                        sortMethod: 'directed',    // Use edge direction
                        nodeSpacing: 150,          // Balanced spacing to prevent overlap
                        levelSeparation: 200,
                        treeSpacing: 150,
                        blockShifting: true,
                        edgeMinimization: false,   // Disable to prioritize spacing over edge optimization
                        parentCentralization: true
                    }
                },
                physics: {
                    enabled: false  // Disable physics for clean hierarchical layout
                },
                edges: {
                    smooth: {
                        enabled: true,
                        type: 'cubicBezier',
                        forceDirection: 'vertical',
                        roundness: 0.5
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 100,
                    zoomView: true,
                    dragView: true
                },
                nodes: {
                    borderWidth: 2,
                    borderWidthSelected: 4,
                    margin: 12,
                    widthConstraint: {
                        maximum: 180
                    },
                    shadow: {
                        enabled: false,
                        color: 'rgba(0,0,0,0.2)',
                        size: 10,
                        x: 2,
                        y: 2
                    },
                    chosen: {
                        node: function(values, id, selected, hovering) {
                            if (selected) {
                                values.shadow = true;
                                values.shadowColor = 'rgba(255, 215, 0, 0.8)';
                                values.shadowSize = 25;
                                values.shadowX = 0;
                                values.shadowY = 0;
                                values.borderWidth = 5;
                                values.borderColor = '#FFD700';
                            }
                        }
                    }
                }
            };

            graphNetwork = new vis.Network(container, data, options);

            // Handle node clicks
            graphNetwork.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = graphNodes.get(nodeId);
                    if (node && node.item) {
                        selectRelated(node.item, false, false); // Don't scroll and don't focus when clicking in graph
                    }
                }
            });
        }

        function getItemProperties(item) {
            const props = [];
            const type = item._type;

            if (type === 'vannkraftverk') {
                props.push({ label: 'Kraftverksnr', value: item.vannkraftverkNr });
                props.push({ label: 'Type', value: item.vannkraftverkType });
                props.push({ label: 'Maks ytelse (MW)', value: item.maksYtelse_MW });
                props.push({ label: 'Brutto fallh√∏yde (m)', value: item.bruttoFallhoyde_m });
                props.push({ label: 'Idriftsatt √•r', value: item.idriftsattAar });
                props.push({ label: 'Status', value: item.status });
                props.push({ label: 'KDB-nummer', value: item.kdbNr });
                props.push({ label: 'Kommune', value: item.kommuneNavn });
                props.push({ label: 'Fylke', value: item.fylke });
                props.push({ label: 'Vassdragsnr', value: item.vassdragsNr });
                props.push({ label: 'Eier', value: item.vannkraftverkEier, fullWidth: true });
            } else if (type === 'dam') {
                props.push({ label: 'Damnr', value: item.damNr });
                props.push({ label: 'Kategori', value: item.damKategori });
                props.push({ label: 'Hovedtype', value: item.damHovedType });
                props.push({ label: 'H√∏yde damtopp (moh)', value: item.hohDamTopp });
                props.push({ label: 'Volum oppdemt (Mm¬≥)', value: item.volumOppdemt_Mm3 });
                props.push({ label: 'Idriftsatt √•r', value: item.idriftsattAar });
                props.push({ label: 'Status', value: item.status });
                props.push({ label: 'KDB-nummer', value: item.kdbNr });
                props.push({ label: 'Kommune', value: item.kommuneNavn });
                props.push({ label: 'Fylke', value: item.fylke });
                props.push({ label: 'Vassdragsnr', value: item.vassdragsNr });
                props.push({ label: 'Kraftverk', value: item.vannkraftverkNavn });
                props.push({ label: 'Magasin', value: item.magasinNavn });
                props.push({ label: 'Damansvarlig', value: item.damAnsvarlig, fullWidth: true });
            } else if (type === 'magasin') {
                props.push({ label: 'Magasinnr', value: item.magasinNr });
                props.push({ label: 'Kategori', value: item.magasinKategori });
                props.push({ label: 'LRV (moh)', value: item.lavesteRegulerteVannstand_moh });
                props.push({ label: 'HRV (moh)', value: item.hoyesteRegulerteVannstand_moh });
                props.push({ label: 'Volum oppdemt (Mm¬≥)', value: item.volumOppdemt_Mm3 });
                props.push({ label: 'Idriftsatt √•r', value: item.idriftsattAar });
                props.push({ label: 'Status', value: item.status });
                props.push({ label: 'KDB-nummer', value: item.kdbNr });
                props.push({ label: 'Vassdragsnr', value: item.vassdragsNr });
                props.push({ label: 'Kraftverk', value: item.vannkraftverkNavn });
            } else if (type === 'vannvei') {
                props.push({ label: 'VannveiID', value: item.vannveiID });
                props.push({ label: 'Objekttype', value: item.objektType });
                props.push({ label: 'Medium', value: item.medium });
                props.push({ label: 'Lengde (m)', value: item.vannveiLengde_m });
                props.push({ label: 'Status', value: item.status });
                props.push({ label: 'Idriftsatt √•r', value: item.idriftsattAar });
                props.push({ label: 'KDB-nummer', value: item.kdbNr });
                props.push({ label: 'Kraftverk', value: item.vannkraftverkNavn });
            } else if (type === 'inntakspunkt') {
                props.push({ label: 'VannveiID', value: item.vannveiID });
                props.push({ label: 'Inntakstype', value: item.inntakType });
                props.push({ label: 'Funksjon', value: item.inntakFunksjon });
                props.push({ label: 'H√∏yde (moh)', value: item.hoyde_moh });
                props.push({ label: 'Status', value: item.status });
                props.push({ label: 'KDB-nummer', value: item.kdbNr });
                props.push({ label: 'Kraftverk', value: item.vannkraftverkNavn });
                props.push({ label: 'Delfeltnr', value: item.delfeltNr });
            } else if (type === 'utlopspunkt') {
                props.push({ label: 'VannveiID', value: item.vannveiID });
                props.push({ label: 'Utl√∏pstype', value: item.utlopType });
                props.push({ label: 'Status', value: item.status });
                props.push({ label: 'Kraftverksnr', value: item.vannkraftverkNr });
            }

            if (item.lat && item.lon) {
                props.push({ label: 'Breddegrad', value: item.lat.toFixed(5) });
                props.push({ label: 'Lengdegrad', value: item.lon.toFixed(5) });
            } else if (item.center_lat && item.center_lon) {
                props.push({ label: 'Breddegrad (senter)', value: item.center_lat.toFixed(5) });
                props.push({ label: 'Lengdegrad (senter)', value: item.center_lon.toFixed(5) });
            }

            return props;
        }

        function findRelatedItems(item) {
            const related = [];
            const vannkraftverkNr = item.vannkraftverkNr;
            const vannkraftverkNavn = item.vannkraftverkNavn;
            const kdbNr = item.kdbNr;
            const vassdragsNr = item.vassdragsNr;
            const vannveiID = item.vannveiID;
            const magasinNr = item.magasinNr;

            // If this object belongs to a kraftverk, add the kraftverk first
            if (item._type !== 'vannkraftverk' && (vannkraftverkNr || vannkraftverkNavn)) {
                let kraftverk = null;
                if (vannkraftverkNr) {
                    kraftverk = allData.vannkraftverk.find(k => k.vannkraftverkNr === vannkraftverkNr);
                }
                if (!kraftverk && vannkraftverkNavn) {
                    kraftverk = allData.vannkraftverk.find(k => k.vannkraftverkNavn === vannkraftverkNavn);
                }
                if (kraftverk) {
                    related.push({ ...kraftverk, _type: 'vannkraftverk', relationReason: 'Tilh√∏rer dette kraftverket' });
                }
            }

            // Find by kraftverksnummer
            if (vannkraftverkNr) {
                allData.dammer.forEach(d => {
                    if (d.vannkraftverkNr === vannkraftverkNr && d.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === d.OBJECTID && r._type === 'dam')) {
                        related.push({ ...d, _type: 'dam', relationReason: `Samme kraftverk (${vannkraftverkNr})` });
                    }
                });
                allData.magasiner.forEach(m => {
                    if (m.vannkraftverkNr === vannkraftverkNr && m.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === m.OBJECTID && r._type === 'magasin')) {
                        related.push({ ...m, _type: 'magasin', relationReason: `Samme kraftverk (${vannkraftverkNr})` });
                    }
                });
                allData.vannveier.forEach(v => {
                    if (v.vannkraftverkNr === vannkraftverkNr && v.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === v.OBJECTID && r._type === 'vannvei')) {
                        related.push({ ...v, _type: 'vannvei', relationReason: `Samme kraftverk (${vannkraftverkNr})` });
                    }
                });
                allData.inntakspunkt.forEach(i => {
                    if (i.vannkraftverkNr === vannkraftverkNr && i.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === i.OBJECTID && r._type === 'inntakspunkt')) {
                        related.push({ ...i, _type: 'inntakspunkt', relationReason: `Samme kraftverk (${vannkraftverkNr})` });
                    }
                });
                allData.utlopspunkt.forEach(u => {
                    if (u.vannkraftverkNr === vannkraftverkNr && u.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === u.OBJECTID && r._type === 'utlopspunkt')) {
                        related.push({ ...u, _type: 'utlopspunkt', relationReason: `Samme kraftverk (${vannkraftverkNr})` });
                    }
                });
            }

            // Find by kraftverksnavn (hvis objektet er et kraftverk)
            if (item._type === 'vannkraftverk' && vannkraftverkNavn) {
                allData.dammer.forEach(d => {
                    if (d.vannkraftverkNavn === vannkraftverkNavn && !related.some(r => r.OBJECTID === d.OBJECTID)) {
                        related.push({ ...d, _type: 'dam', relationReason: `Tilh√∏rer kraftverk: ${vannkraftverkNavn}` });
                    }
                });
                allData.magasiner.forEach(m => {
                    if (m.vannkraftverkNavn === vannkraftverkNavn && !related.some(r => r.OBJECTID === m.OBJECTID)) {
                        related.push({ ...m, _type: 'magasin', relationReason: `Tilh√∏rer kraftverk: ${vannkraftverkNavn}` });
                    }
                });
                allData.vannveier.forEach(v => {
                    if (v.vannkraftverkNavn === vannkraftverkNavn && !related.some(r => r.OBJECTID === v.OBJECTID)) {
                        related.push({ ...v, _type: 'vannvei', relationReason: `Tilh√∏rer kraftverk: ${vannkraftverkNavn}` });
                    }
                });
                allData.inntakspunkt.forEach(i => {
                    if (i.vannkraftverkNavn === vannkraftverkNavn && !related.some(r => r.OBJECTID === i.OBJECTID)) {
                        related.push({ ...i, _type: 'inntakspunkt', relationReason: `Tilh√∏rer kraftverk: ${vannkraftverkNavn}` });
                    }
                });
                allData.utlopspunkt.forEach(u => {
                    if (u.vannkraftverkNavn === vannkraftverkNavn && !related.some(r => r.OBJECTID === u.OBJECTID)) {
                        related.push({ ...u, _type: 'utlopspunkt', relationReason: `Tilh√∏rer kraftverk: ${vannkraftverkNavn}` });
                    }
                });
            }

            // Find by KDB-nummer
            if (kdbNr && !related.some(r => r.kdbNr === kdbNr)) {
                const typeMap = {
                    'vannkraftverk': 'vannkraftverk',
                    'dammer': 'dam',
                    'magasiner': 'magasin',
                    'vannveier': 'vannvei',
                    'inntakspunkt': 'inntakspunkt'
                };
                ['vannkraftverk', 'dammer', 'magasiner', 'vannveier', 'inntakspunkt'].forEach(dataType => {
                    allData[dataType].forEach(obj => {
                        if (obj.kdbNr === kdbNr && obj.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === obj.OBJECTID)) {
                            related.push({ ...obj, _type: typeMap[dataType], relationReason: `Samme konsesjon (KDB: ${kdbNr})` });
                        }
                    });
                });
            }

            // Find by vassdragsnummer
            if (vassdragsNr && related.length < 20) {
                const typeMap = {
                    'vannkraftverk': 'vannkraftverk',
                    'dammer': 'dam',
                    'magasiner': 'magasin'
                };
                ['vannkraftverk', 'dammer', 'magasiner'].forEach(dataType => {
                    allData[dataType].forEach(obj => {
                        if (obj.vassdragsNr === vassdragsNr && obj.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === obj.OBJECTID)) {
                            related.push({ ...obj, _type: typeMap[dataType], relationReason: `Samme vassdrag (${vassdragsNr})` });
                        }
                    });
                });
            }

            // Find by vannveiID
            if (vannveiID) {
                allData.vannveier.forEach(v => {
                    if (v.vannveiID === vannveiID && v.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === v.OBJECTID)) {
                        related.push({ ...v, _type: 'vannvei', relationReason: `Samme vannvei-ID (${vannveiID})` });
                    }
                });
                allData.inntakspunkt.forEach(i => {
                    if (i.vannveiID === vannveiID && i.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === i.OBJECTID)) {
                        related.push({ ...i, _type: 'inntakspunkt', relationReason: `Samme vannvei-ID (${vannveiID})` });
                    }
                });
                allData.utlopspunkt.forEach(u => {
                    if (u.vannveiID === vannveiID && u.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === u.OBJECTID)) {
                        related.push({ ...u, _type: 'utlopspunkt', relationReason: `Samme vannvei-ID (${vannveiID})` });
                    }
                });
            }

            // Find by magasinnummer
            if (magasinNr) {
                allData.dammer.forEach(d => {
                    if (d.magasinNr === magasinNr && d.OBJECTID !== item.OBJECTID && !related.some(r => r.OBJECTID === d.OBJECTID)) {
                        related.push({ ...d, _type: 'dam', relationReason: `Samme magasin (${magasinNr})` });
                    }
                });
            }

            // Find by kraftverksnavn (hvis vi ikke har kraftverksnummer)
            if (vannkraftverkNavn && !vannkraftverkNr) {
                allData.vannkraftverk.forEach(k => {
                    if (k.vannkraftverkNavn === vannkraftverkNavn && !related.some(r => r.OBJECTID === k.OBJECTID)) {
                        related.push({ ...k, _type: 'vannkraftverk', relationReason: `Kraftverk: ${vannkraftverkNavn}` });
                    }
                });
            }

            return related.slice(0, 50); // Limit to 50 related items
        }

        // Find only direct "downward" relations for graph display
        function findDirectRelations(item) {
            const direct = [];
            const vannkraftverkNr = item.vannkraftverkNr;
            const vannkraftverkNavn = item.vannkraftverkNavn;

            // Only show children for kraftverk - this creates a clean hierarchy
            if (item._type === 'vannkraftverk') {
                // Find dams for this kraftverk
                const dams = [];
                allData.dammer.forEach(d => {
                    if ((d.vannkraftverkNr && d.vannkraftverkNr === vannkraftverkNr) ||
                        (d.vannkraftverkNavn && d.vannkraftverkNavn === vannkraftverkNavn)) {
                        dams.push({ ...d, _type: 'dam' });
                    }
                });

                // Find magasiner - both via dam references and kraftverk membership
                const magasiner = [];
                const magasinerAdded = new Map(); // Track by OBJECTID, store parent dams

                // First: Add magasiner that are referenced by dams (regardless of kraftverk)
                dams.forEach(dam => {
                    if (dam.magasinNr) {
                        const magasin = allData.magasiner.find(m => m.magasinNr === dam.magasinNr);
                        if (magasin) {
                            if (!magasinerAdded.has(magasin.OBJECTID)) {
                                // First dam for this magasin
                                magasinerAdded.set(magasin.OBJECTID, [dam.OBJECTID]);
                            } else {
                                // Additional dam for this magasin
                                magasinerAdded.get(magasin.OBJECTID).push(dam.OBJECTID);
                            }
                        }
                    }
                });

                // Add magasiner with their parent dams
                magasinerAdded.forEach((parentDamIds, magasinObjectId) => {
                    const magasin = allData.magasiner.find(m => m.OBJECTID === magasinObjectId);
                    if (magasin) {
                        magasiner.push({ ...magasin, _type: 'magasin', _parentDamIds: parentDamIds });
                    }
                });

                // Second: Add magasiner that belong to this kraftverk but don't have a parent dam
                allData.magasiner.forEach(m => {
                    if ((m.vannkraftverkNr && m.vannkraftverkNr === vannkraftverkNr) ||
                        (m.vannkraftverkNavn && m.vannkraftverkNavn === vannkraftverkNavn)) {

                        // Only add if not already added via parent dam
                        if (!magasinerAdded.has(m.OBJECTID)) {
                            magasiner.push({ ...m, _type: 'magasin' });
                        }
                    }
                });

                // Add dams to direct list
                direct.push(...dams);

                // Add magasiner to direct list
                direct.push(...magasiner);

                // Find vannveier for this kraftverk
                allData.vannveier.forEach(v => {
                    if ((v.vannkraftverkNr && v.vannkraftverkNr === vannkraftverkNr) ||
                        (v.vannkraftverkNavn && v.vannkraftverkNavn === vannkraftverkNavn)) {
                        direct.push({ ...v, _type: 'vannvei' });
                    }
                });

                // Find inntakspunkt for this kraftverk
                allData.inntakspunkt.forEach(i => {
                    if ((i.vannkraftverkNr && i.vannkraftverkNr === vannkraftverkNr) ||
                        (i.vannkraftverkNavn && i.vannkraftverkNavn === vannkraftverkNavn)) {
                        direct.push({ ...i, _type: 'inntakspunkt' });
                    }
                });

                // Find utl√∏pspunkt for this kraftverk
                allData.utlopspunkt.forEach(u => {
                    if ((u.vannkraftverkNr && u.vannkraftverkNr === vannkraftverkNr) ||
                        (u.vannkraftverkNavn && u.vannkraftverkNavn === vannkraftverkNavn)) {
                        direct.push({ ...u, _type: 'utlopspunkt' });
                    }
                });
            }

            // For all other types: no children shown in graph to maintain clean hierarchy
            // They still show all related items in the "Relaterte objekter" section

            return direct;
        }

        function selectRelatedByIndex(relIndex) {
            if (relIndex < 0 || relIndex >= currentRelatedItems.length) {
                console.error('Invalid related item index:', relIndex);
                return;
            }
            const relatedItem = currentRelatedItems[relIndex];
            selectRelated(relatedItem);
        }

        function selectRelated(relatedItem, shouldScroll = true, focusInGraph = true) {
            // Find the item in filteredResults or add it temporarily
            let index = filteredResults.findIndex(r => r.OBJECTID === relatedItem.OBJECTID && r._type === relatedItem._type);

            // If item is not found OR is beyond the first 200 displayed items, add it to the top
            if (index === -1 || index >= 200) {
                // Remove from current position if it exists
                if (index !== -1) {
                    filteredResults.splice(index, 1);
                }
                // Item not in current filtered results, add it temporarily at the top
                filteredResults.unshift(relatedItem);
                displayResults();
                index = 0;
            }

            // Select the item (and optionally scroll to it)
            const resultItems = document.querySelectorAll('.result-item');
            if (resultItems[index]) {
                if (shouldScroll) {
                    resultItems[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                selectItem(index, focusInGraph);
            }
        }

        function navigateToKraftverk(kraftverkNavn, kraftverkNr) {
            // Find the kraftverk in allData
            let kraftverk = null;

            if (kraftverkNr) {
                kraftverk = allData.vannkraftverk.find(k => k.vannkraftverkNr === kraftverkNr);
            }

            if (!kraftverk && kraftverkNavn) {
                kraftverk = allData.vannkraftverk.find(k => k.vannkraftverkNavn === kraftverkNavn);
            }

            if (kraftverk) {
                // Add _type for consistency
                const kraftverkWithType = { ...kraftverk, _type: 'vannkraftverk' };
                selectRelated(kraftverkWithType);
            } else {
                alert('Kunne ikke finne kraftverk: ' + kraftverkNavn);
            }
        }

        function resetGraph() {
            graphNodes.clear();
            graphEdges.clear();
            if (graphNetwork) {
                graphNetwork.destroy();
                graphNetwork = null;
            }
            // Refresh current view to reinitialize with just current item
            if (currentSelection) {
                displayDetail(currentSelection);
            }
        }

        function openMap(lat, lon, name) {
            const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}&query_place_id=${encodeURIComponent(name)}`;
            window.open(url, '_blank');
        }

        function openInKonsesjon(kdbNr) {
            const url = `http://konsesjoner/Vassdrag/Vassdrag/Details/${kdbNr}`;
            window.open(url, '_blank');
        }

        function openInUtbygd(kraftverksID) {
            const url = `http://utbygd/Vannkraft/Kraftverk/Details/${kraftverksID}`;
            window.open(url, '_blank');
        }

        function resetFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchType').value = '';
            document.getElementById('searchKommune').value = '';
            document.getElementById('searchVassdrags').value = '';
            filterData();
        }

        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            // Event listeners
            document.getElementById('searchName').addEventListener('input', filterData);
            document.getElementById('searchType').addEventListener('change', filterData);
            document.getElementById('searchKommune').addEventListener('change', filterData);
            document.getElementById('searchVassdrags').addEventListener('input', filterData);

            // Event delegation for related items
            const detailPanel = document.getElementById('detailPanel');
            if (detailPanel) {
                detailPanel.addEventListener('click', function(e) {
                    const relatedItem = e.target.closest('.related-item');
                    if (relatedItem && relatedItem.dataset.relIndex !== undefined) {
                        const relIndex = parseInt(relatedItem.dataset.relIndex, 10);
                        selectRelatedByIndex(relIndex);
                    }
                });
            }

            // Make functions globally accessible for onclick handlers in innerHTML
            window.selectItem = selectItem;
            window.selectRelatedByIndex = selectRelatedByIndex;
            window.openMap = openMap;
            window.resetFilters = resetFilters;
            window.navigateToKraftverk = navigateToKraftverk;
            window.openInKonsesjon = openInKonsesjon;
            window.openInUtbygd = openInUtbygd;
            window.resetGraph = resetGraph;

            // Load data on page load
            loadData();
        }
    </script>
</body>
</html>
